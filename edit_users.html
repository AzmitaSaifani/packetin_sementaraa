<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Edit Data Pengguna - Packetin</title>
    <link
      href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css"
      rel="stylesheet"
    />
    <link href="css/styles.css" rel="stylesheet" />
    <script
      src="https://use.fontawesome.com/releases/v6.3.0/js/all.js"
      crossorigin="anonymous"
    ></script>
    <script src="js/server.js"></script>
    <script src="js/config.js"></script>
  </head>
  <body class="sb-nav-fixed">
    <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
      <!-- Navbar Brand-->
      <a class="navbar-brand ps-3" href="home.html">Packetin</a>
      <!-- Sidebar Toggle-->
      <button
        class="btn btn-link btn-sm order-1 order-lg-0 me-4 me-lg-0"
        id="sidebarToggle"
        href="#!"
      >
        <i class="fas fa-bars"></i>
      </button>
      <div class="flex-grow-1"></div>
    </nav>
    <div id="layoutSidenav">
      <div id="layoutSidenav_nav">
        <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
          <div class="sb-sidenav-menu">
            <div class="nav">
              <a id="dashboard" class="nav-link" href="home.html">
                <div class="sb-nav-link-icon">
                  <i class="fa-solid fa-house"></i>
                </div>
                Dashboard
              </a>
              <a id="tabel_datang" class="nav-link" href="tabel_datang.html">
                <div class="sb-nav-link-icon">
                  <i class="fa-solid fa-truck-fast"></i>
                </div>
                Kedatangan Paket
              </a>
              <a id="tabel_ambil" class="nav-link" href="tabel_ambil.html">
                <div class="sb-nav-link-icon">
                  <i class="fa-solid fa-dolly"></i>
                </div>
                Pengambilan Paket
              </a>
              <a id="laporan" class="nav-link" href="laporan.html">
                <div class="sb-nav-link-icon">
                  <i class="fa-regular fa-clipboard"></i>
                </div>
                Laporan Paket
              </a>
              <a id="tabel_users" class="nav-link" href="tabel_users.html">
                <div class="sb-nav-link-icon">
                  <i class="fa-solid fa-user"></i>
                </div>
                Tabel Pengguna
              </a>
              <a
                class="nav-link collapsed"
                href="#"
                onclick="showLogoutModal()"
              >
                <div class="sb-nav-link-icon">
                  <i class="fa-solid fa-right-to-bracket"></i>
                </div>
                Logout
              </a>
            </div>
          </div>
          <div class="sb-sidenav-footer">
            <div class="small">Login Sebagai:</div>
          </div>
        </nav>
      </div>
      <div id="layoutSidenav_content">
        <main>
          <div class="container-fluid px-4">
            <h1 class="mt-4">Edit Data Pengguna</h1>
            <div class="card mb-4"></div>
          </div>
          <form id="edit_users" class="container">
            <div class="row justify-content-center">
              <div class="col-lg-7">
                <b><label for="username">Username:</label></b>
                <input
                  type="text"
                  id="username"
                  placeholder="Username"
                  class="form-control mb-3"
                  required
                />
                <b><label for="password">Password:</label></b>
                <input
                  type="text"
                  id="password"
                  placeholder="Password"
                  class="form-control mb-3"
                />
                <input type="hidden" id="id_user" required />
                <b><label for="level">Level:</label></b>
                <select id="level" class="form-control mb-3" required>
                  <option value="" disabled selected>Pilih Level</option>
                </select>
                <button
                  type="submit"
                  class="btn btn-success"
                  id="user"
                  required
                >
                  Submit
                </button>
                <button
                  type="button"
                  class="btn btn-danger"
                  id="cancelEdit_user"
                >
                  Cancel
                </button>
              </div>
            </div>
          </form>
        </main>
      </div>
    </div>
    <!-- Modal Edit users sukses -->
    <div
      class="modal fade"
      id="editModal"
      tabindex="-1"
      aria-labelledby="inputUsersModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="inputUsersModalLabel">Notifikasi</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">Edit Data Pengguna Berhasil</div>
          <div class="modal-footer">
            <button
              type="button"
              id="closeInput"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal Gagal Add-->
    <div
      class="modal fade"
      id="gagalModal"
      tabindex="-1"
      aria-labelledby="gagalModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="gagalModalLabel">Peringatan!</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            Terjadi Kesalahan Dalam Mengedit Kedatangan Paket
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- modal logout -->
    <div
      class="modal fade"
      id="logoutModal"
      tabindex="-1"
      aria-labelledby="logoutModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="logoutModalLabel">Notifikasi</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">Apakah Anda yakin ingin Logout?</div>
          <div class="modal-footer">
            <button
              type="button"
              id="closeInput"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-danger" id="confirmLogout">
              Logout
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- dropdown level, gajadi dipake, karna seringkali bugs. pengambilan value dari database dan level bingung -->
    <!-- <script>
      document.addEventListener("DOMContentLoaded", () => {
        fetch(`${url}/level`)
          .then((response) => response.json())
          .then((data) => {
            const select = document.getElementById("level");
            data.forEach((level) => {
              const option = document.createElement("option");
              option.value = level.level;
              option.textContent = level.level;
              select.appendChild(option);
            });
          })
          .catch((error) => console.error("Error fetching levels:", error));
      });
    </script> -->
    
    <!-- Mengambil value tabel awal, post data edit -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        fetch(`${url}/session-data`, {
          credentials: "include",
        })
          .then((response) => response.json())
          .then((data) => {
            if (!data.username) {
              window.location.href = "index.html";
            } else {
              // hide menu untuk satpam
              const username = data.username;
              fetch(`${url}/get_level?username=${username}`)
                .then((response) => response.json())
                .then((levelData) => {
                  console.log("Level data received:", levelData);
                  const level = levelData.level;

                  if (level === "Satpam") {
                    // Sembunyikan semua menu
                    console.log("Hiding elements for Satpam");
                    const tabel_users = document.getElementById("tabel_users");
                    if (tabel_users) tabel_users.style.display = "none";
                  }
                });

              function getQueryParams() {
                const params = new URLSearchParams(window.location.search);
                return {
                  username: params.get("username"),
                  password: params.get("password"),
                  level: params.get("level"),
                  id_user: params.get("id_user"),
                };
              }

              function populateDropdown() {
                return fetch(`${url}/level`)
                  .then((response) => {
                    if (!response.ok) {
                      throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                  })
                  .then((data) => {
                    const select = document.getElementById("level");
                    data.forEach((level) => {
                      const option = document.createElement("option");
                      option.value = level.level;
                      option.textContent = level.level;
                      select.appendChild(option);
                    });
                    // Return the select element after populating it
                    return select;
                  });
              }

              // ngemacth in level di database dan di dropdown level, menghindari terjadinya bug
              function setUserLevel(select) {
                if (
                  user.level &&
                  select.querySelector(`option[value="${user.level}"]`)
                ) {
                  select.value = user.level;
                } else {
                  console.warn(
                    `User level "${user.level}" not found in dropdown options.`
                  );
                }
              }

              const user = getQueryParams();
              document.getElementById("username").value = user.username;
              document.getElementById("username").disabled = true;
              // document.getElementById("password").value = user.password;
              // document.getElementById("level").value = user.level;
              // console.log("hihihihihih", user.level);
              // document.getElementById("level").value = "Satpam";
              populateDropdown().then((select) => {
                setUserLevel(select);
              });
              document.getElementById("id_user").value = user.id_user;
              console.log("1", user.username);
              // console.log("2", user.password);
              console.log("2", user.level);
              console.log("3", user.id_user);

              // document.addEventListener('DOMContentLoaded', function () {
              const addUserForm = document.getElementById("edit_users");

              addUserForm.addEventListener("submit", function (event) {
                event.preventDefault();

                const username = document.getElementById("username");
                const password = document.getElementById("password");
                const level = document.getElementById("level");
                const id_user = document.getElementById("id_user");
                const inputValueusername = username.value;
                const inputValuepassword = password.value;
                const inputValuelevel = level.value;
                const inputValueid_user = id_user.value;
                console.log("11", inputValueusername);
                console.log("22", inputValuepassword);
                console.log("33", inputValuelevel);
                console.log("44", inputValueid_user);

                fetch(`${url}/users_put`, {
                  method: "PUT",
                  body: JSON.stringify({
                    username: inputValueusername,
                    password: inputValuepassword,
                    level: inputValuelevel,
                    id_user: inputValueid_user,
                  }),
                  headers: {
                    "Content-Type": "application/json",
                  },
                })
                  .then((response) => {
                    if (!response.ok) {
                      throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                  })
                  .then((data) => {
                    if (data.code === "200") {
                      const editModal = new bootstrap.Modal(
                        document.getElementById("editModal")
                      );
                      editModal.show();
                    } else {
                      const gagalModal = new bootstrap.Modal(
                        document.getElementById("gagalModal")
                      );
                      gagalModal.show();
                    }
                  })
                  .catch((error) => {
                    console.error("Error editing user:", error);
                    alert("Failed to edit user");
                  });
              });
              document
                .getElementById("closeInput")
                .addEventListener("click", function (event) {
                  window.location.href = `tabel_users.html`;
                });
              // });
              document
                .getElementById("cancelEdit_user")
                .addEventListener("click", function (event) {
                  window.location.href = `tabel_users.html`;
                });
            }
          })
          .catch((error) => {
            console.error("Error fetching session data:", error);
          });
      });
    </script>
    <!-- logout -->
    <script>
      function showLogoutModal() {
        var logoutModal = new bootstrap.Modal(
          document.getElementById("logoutModal")
        );
        logoutModal.show();
      }
      function logout() {
        event.preventDefault();
        fetch(`${url}/logout`, {
          credentials: "include",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.code == "200") {
              window.location.href = "index.html";
            } else {
              console.log("Gagal Logout");
            }
          })
          .catch((error) => {
            console.error("Error fetching data:", error);
          });
      }
      document
        .getElementById("confirmLogout")
        .addEventListener("click", function () {
          logout();
        });
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>
    <script src="js/scripts.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"
      crossorigin="anonymous"
    ></script>
    <script src="assets/demo/chart-area-demo.js"></script>
    <script src="assets/demo/chart-bar-demo.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/umd/simple-datatables.min.js"
      crossorigin="anonymous"
    ></script>
    <script src="js/datatables-simple-demo.js"></script>
  </body>
</html>
